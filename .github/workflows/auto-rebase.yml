name: Auto Rebase PR Branch

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-rebase:
    if: >-
      github.event.issue.pull_request &&
      github.event.comment.body == '/rebase'
    runs-on: ubuntu-latest

    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('head_repo', pr.data.head.repo.full_name);
            core.setOutput('is_same_repo', pr.data.head.repo.full_name === `${context.repo.owner}/${context.repo.repo}` ? 'true' : 'false');

      - name: Validate branch source
        if: steps.pr.outputs.is_same_repo != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '⚠️ 자동 rebase는 같은 저장소 브랜치에서만 지원됩니다.'
            });
            core.setFailed('Fork PR is not supported for auto-rebase.');

      - name: Checkout PR branch
        if: steps.pr.outputs.is_same_repo == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Configure git identity
        if: steps.pr.outputs.is_same_repo == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Rebase onto main with ours conflict strategy
        if: steps.pr.outputs.is_same_repo == 'true'
        id: rebase
        run: |
          set -e
          git fetch origin main
          if git rebase origin/main -X ours; then
            echo "result=success" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git rebase --abort || true
          while [ -n "$(git diff --name-only --diff-filter=U)" ]; do
            git diff --name-only --diff-filter=U | xargs -r git checkout --ours --
            git add -A
            GIT_EDITOR=true git rebase --continue || true
          done
          if [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then
            echo "result=failed" >> "$GITHUB_OUTPUT"
            exit 1
          fi
          echo "result=success" >> "$GITHUB_OUTPUT"

      - name: Push rebased branch
        if: steps.pr.outputs.is_same_repo == 'true' && steps.rebase.outputs.result == 'success'
        run: |
          git push --force-with-lease origin "HEAD:${{ steps.pr.outputs.head_ref }}"

      - name: Comment success
        if: steps.pr.outputs.is_same_repo == 'true' && success() && steps.rebase.outputs.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '✅ rebase 완료! PR 브랜치를 main 기준으로 rebase했습니다.'
            });

      - name: Comment failure
        if: failure() && steps.pr.outputs.is_same_repo == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '❌ rebase 자동 처리 중 실패했습니다. Actions 로그를 확인해 주세요.'
            });
