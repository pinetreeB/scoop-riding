<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCOOP Riding - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .modal { display: none; }
    .modal.active { display: flex; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn.active { background: #f97316; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <header class="bg-orange-500 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
          <span class="text-orange-500 font-bold text-xl">S</span>
        </div>
        <h1 class="text-xl font-bold">SCOOP Riding ê´€ë¦¬ì</h1>
      </div>
      <div class="flex items-center gap-4">
        <span id="adminEmail" class="text-sm opacity-80"></span>
        <button onclick="logout()" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <!-- Login Section -->
  <div id="loginSection" class="max-w-md mx-auto mt-20 p-6 bg-white rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold text-center mb-6">ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <form onsubmit="login(event)">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
        <input type="email" id="loginEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="loginPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500">
      </div>
      <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-semibold">ë¡œê·¸ì¸</button>
      <p id="loginError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
    </form>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboardSection" class="hidden">
    <div class="max-w-7xl mx-auto px-4 py-6">
      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-xl p-6 shadow">
          <div class="text-gray-500 text-sm">ì „ì²´ ì‚¬ìš©ì</div>
          <div id="statTotalUsers" class="text-3xl font-bold text-gray-800">-</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow">
          <div class="text-gray-500 text-sm">ì˜¤ëŠ˜ ê°€ì…</div>
          <div id="statTodayUsers" class="text-3xl font-bold text-green-600">-</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow">
          <div class="text-gray-500 text-sm">ì´ ì£¼í–‰ ê¸°ë¡</div>
          <div id="statTotalRides" class="text-3xl font-bold text-blue-600">-</div>
        </div>
        <div class="bg-white rounded-xl p-6 shadow">
          <div class="text-gray-500 text-sm">ì´ ì£¼í–‰ ê±°ë¦¬</div>
          <div id="statTotalDistance" class="text-3xl font-bold text-orange-500">-</div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="bg-white rounded-xl shadow mb-6 p-2 flex flex-wrap gap-2">
        <button onclick="switchTab('users')" class="tab-btn active px-4 py-2 rounded-lg font-medium" data-tab="users">ì‚¬ìš©ì ê´€ë¦¬</button>
        <button onclick="switchTab('announcements')" class="tab-btn px-4 py-2 rounded-lg font-medium" data-tab="announcements">ê³µì§€ì‚¬í•­</button>
        <button onclick="switchTab('surveys')" class="tab-btn px-4 py-2 rounded-lg font-medium" data-tab="surveys">ì„¤ë¬¸ ì‘ë‹µ</button>
        <button onclick="switchTab('bugs')" class="tab-btn px-4 py-2 rounded-lg font-medium" data-tab="bugs">ë²„ê·¸ ë¦¬í¬íŠ¸</button>
        <button onclick="switchTab('posts')" class="tab-btn px-4 py-2 rounded-lg font-medium" data-tab="posts">ê²Œì‹œê¸€ ê´€ë¦¬</button>
      </div>

      <!-- Users Tab -->
      <div id="tab-users" class="tab-content active">
        <div class="bg-white rounded-xl p-4 shadow mb-4">
          <div class="flex flex-wrap gap-4 items-center">
            <input type="text" id="searchInput" placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." class="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 rounded-lg" onkeyup="debounceSearch()">
            <select id="filterRole" onchange="loadUsers()" class="px-4 py-2 border border-gray-300 rounded-lg">
              <option value="">ì „ì²´ ì—­í• </option>
              <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
              <option value="admin">ê´€ë¦¬ì</option>
            </select>
            <button onclick="loadUsers()" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2 rounded-lg">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë©”ì¼</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì—­í• </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê°€ì…ì¼</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‘ì—…</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-200">
              <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Announcements Tab -->
      <div id="tab-announcements" class="tab-content">
        <div class="bg-white rounded-xl p-4 shadow mb-4 flex justify-between items-center">
          <h3 class="text-lg font-semibold">ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
          <button onclick="openAnnouncementModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg">ìƒˆ ê³µì§€ ì‘ì„±</button>
        </div>
        <div id="announcementsList" class="space-y-4"></div>
      </div>

      <!-- Surveys Tab -->
      <div id="tab-surveys" class="tab-content">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-xl p-4 shadow">
            <div class="text-gray-500 text-sm">ì´ ì‘ë‹µ</div>
            <div id="surveyTotal" class="text-2xl font-bold text-gray-800">-</div>
          </div>
          <div class="bg-white rounded-xl p-4 shadow">
            <div class="text-gray-500 text-sm">í‰ê·  í‰ì </div>
            <div id="surveyAvgRating" class="text-2xl font-bold text-yellow-500">-</div>
          </div>
          <div class="bg-white rounded-xl p-4 shadow">
            <div class="text-gray-500 text-sm">ì¶”ì²œìœ¨</div>
            <div id="surveyRecommendRate" class="text-2xl font-bold text-green-600">-</div>
          </div>
          <div class="bg-white rounded-xl p-4 shadow">
            <div class="text-gray-500 text-sm">ê°€ì¥ ë§ì´ ì‚¬ìš©í•œ ê¸°ëŠ¥</div>
            <div id="surveyTopFeature" class="text-lg font-bold text-blue-600">-</div>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‚¬ìš©ì</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í‰ì </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì¶”ì²œ</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì£¼ìš” ê¸°ëŠ¥</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">í”¼ë“œë°±</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë‚ ì§œ</th>
              </tr>
            </thead>
            <tbody id="surveysTableBody" class="divide-y divide-gray-200">
              <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Bugs Tab -->
      <div id="tab-bugs" class="tab-content">
        <div class="bg-white rounded-xl p-4 shadow mb-4">
          <h3 class="text-lg font-semibold">ë²„ê·¸ ë¦¬í¬íŠ¸ ê´€ë¦¬</h3>
        </div>
        <div id="bugsList" class="space-y-4"></div>
      </div>

      <!-- Posts Tab -->
      <div id="tab-posts" class="tab-content">
        <div class="bg-white rounded-xl p-4 shadow mb-4">
          <h3 class="text-lg font-semibold">ê²Œì‹œê¸€ ê´€ë¦¬</h3>
        </div>
        <div id="postsList" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
      <h3 class="text-xl font-bold mb-4">ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h3>
      <form onsubmit="saveUser(event)">
        <input type="hidden" id="editUserId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
          <input type="text" id="editName" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label>
          <input type="email" id="editEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ì—­í• </label>
          <select id="editRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="user">ì¼ë°˜ ì‚¬ìš©ì</option>
            <option value="admin">ê´€ë¦¬ì</option>
          </select>
        </div>
        <div class="flex gap-3 mt-6">
          <button type="button" onclick="closeModal('editModal')" class="flex-1 px-4 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button>
          <button type="submit" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Announcement Modal -->
  <div id="announcementModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold mb-4" id="announcementModalTitle">ìƒˆ ê³µì§€ì‚¬í•­</h3>
      <form onsubmit="saveAnnouncement(event)">
        <input type="hidden" id="announcementId">
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ìœ í˜•</label>
          <select id="announcementType" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
            <option value="notice">ê³µì§€</option>
            <option value="update">ì—…ë°ì´íŠ¸</option>
            <option value="event">ì´ë²¤íŠ¸</option>
            <option value="maintenance">ì ê²€</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ì œëª©</label>
          <input type="text" id="announcementTitle" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ë‚´ìš©</label>
          <textarea id="announcementContent" rows="6" required class="w-full px-4 py-2 border border-gray-300 rounded-lg"></textarea>
        </div>
        <div class="mb-4 flex gap-4">
          <label class="flex items-center gap-2">
            <input type="checkbox" id="announcementShowPopup" checked class="w-4 h-4">
            <span class="text-sm">íŒì—… í‘œì‹œ</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" id="announcementIsActive" checked class="w-4 h-4">
            <span class="text-sm">í™œì„±í™”</span>
          </label>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">ë§Œë£Œì¼ (ì„ íƒ)</label>
          <input type="datetime-local" id="announcementExpiresAt" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        </div>
        <div class="flex gap-3 mt-6">
          <button type="button" onclick="closeModal('announcementModal')" class="flex-1 px-4 py-2 bg-gray-200 rounded-lg">ì·¨ì†Œ</button>
          <button type="submit" class="flex-1 px-4 py-2 bg-orange-500 text-white rounded-lg">ì €ì¥</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let currentPage = 1, totalPages = 1, searchTimeout = null;
    let adminToken = localStorage.getItem('adminToken');
    
    document.addEventListener('DOMContentLoaded', () => { 
      if (adminToken) checkAuth(); 
    });

    async function checkAuth() {
      try {
        const res = await fetch(API_BASE+'/api/admin/me', { headers: { 'Authorization': 'Bearer '+adminToken } });
        if (res.ok) { 
          const data = await res.json(); 
          document.getElementById('adminEmail').textContent = data.email; 
          showDashboard(); 
          loadStats(); 
          loadUsers(); 
        } else logout();
      } catch (e) { logout(); }
    }

    async function login(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      try {
        const res = await fetch(API_BASE+'/api/admin/login', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ email, password }) 
        });
        const data = await res.json();
        if (res.ok && data.token) { 
          adminToken = data.token; 
          localStorage.setItem('adminToken', adminToken); 
          document.getElementById('adminEmail').textContent = email; 
          showDashboard(); 
          loadStats(); 
          loadUsers(); 
        } else { 
          document.getElementById('loginError').textContent = data.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'; 
          document.getElementById('loginError').classList.remove('hidden'); 
        }
      } catch (e) { 
        document.getElementById('loginError').textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨'; 
        document.getElementById('loginError').classList.remove('hidden'); 
      }
    }

    function logout() { 
      adminToken = null; 
      localStorage.removeItem('adminToken'); 
      document.getElementById('loginSection').classList.remove('hidden'); 
      document.getElementById('dashboardSection').classList.add('hidden'); 
    }

    function showDashboard() { 
      document.getElementById('loginSection').classList.add('hidden'); 
      document.getElementById('dashboardSection').classList.remove('hidden'); 
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector('[data-tab="'+tabName+'"]').classList.add('active');
      document.getElementById('tab-'+tabName).classList.add('active');
      
      switch(tabName) {
        case 'users': loadUsers(); break;
        case 'announcements': loadAnnouncements(); break;
        case 'surveys': loadSurveys(); break;
        case 'bugs': loadBugs(); break;
        case 'posts': loadPosts(); break;
      }
    }

    async function loadStats() {
      try {
        const res = await fetch(API_BASE+'/api/admin/stats', { headers: { 'Authorization': 'Bearer '+adminToken } });
        const data = await res.json();
        document.getElementById('statTotalUsers').textContent = data.totalUsers?.toLocaleString() || '0';
        document.getElementById('statTodayUsers').textContent = data.todayUsers?.toLocaleString() || '0';
        document.getElementById('statTotalRides').textContent = data.totalRides?.toLocaleString() || '0';
        document.getElementById('statTotalDistance').textContent = (data.totalDistance ? (data.totalDistance / 1000).toFixed(1) + ' km' : '0 km');
      } catch (e) { console.error(e); }
    }

    function debounceSearch() { 
      clearTimeout(searchTimeout); 
      searchTimeout = setTimeout(() => { currentPage = 1; loadUsers(); }, 300); 
    }

    async function loadUsers() {
      const search = document.getElementById('searchInput').value;
      const role = document.getElementById('filterRole').value;
      try {
        const params = new URLSearchParams({ page: currentPage, limit: 20, ...(search && { search }), ...(role && { role }) });
        const res = await fetch(API_BASE+'/api/admin/users?'+params, { headers: { 'Authorization': 'Bearer '+adminToken } });
        const data = await res.json();
        totalPages = data.totalPages || 1;
        renderUsers(data.users || []);
      } catch (e) { console.error(e); }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTableBody');
      if (users.length === 0) { 
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'; 
        return; 
      }
      tbody.innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm">${u.id}</td>
          <td class="px-4 py-3 text-sm font-medium">${u.name||'-'}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${u.email||'-'}</td>
          <td class="px-4 py-3 text-sm">
            <span class="px-2 py-1 rounded-full text-xs ${u.role==='admin'?'bg-red-100 text-red-800':'bg-green-100 text-green-800'}">${u.role}</span>
          </td>
          <td class="px-4 py-3 text-sm text-gray-600">${formatDate(u.createdAt)}</td>
          <td class="px-4 py-3 text-sm">
            <button onclick="editUser(${u.id})" class="text-orange-600 hover:text-orange-800 mr-2">ìˆ˜ì •</button>
            <button onclick="deleteUser(${u.id})" class="text-red-600 hover:text-red-800">ì‚­ì œ</button>
          </td>
        </tr>
      `).join('');
    }

    async function editUser(userId) {
      try {
        const res = await fetch(API_BASE+'/api/admin/users/'+userId, { headers: { 'Authorization': 'Bearer '+adminToken } });
        const user = await res.json();
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editName').value = user.name || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editRole').value = user.role || 'user';
        document.getElementById('editModal').classList.add('active');
      } catch (e) { alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    }

    function closeModal(modalId) { 
      document.getElementById(modalId).classList.remove('active'); 
    }

    async function saveUser(e) {
      e.preventDefault();
      const userId = document.getElementById('editUserId').value;
      const data = { 
        name: document.getElementById('editName').value, 
        email: document.getElementById('editEmail').value, 
        role: document.getElementById('editRole').value 
      };
      try {
        const res = await fetch(API_BASE+'/api/admin/users/'+userId, { 
          method: 'PUT', 
          headers: { 'Authorization': 'Bearer '+adminToken, 'Content-Type': 'application/json' }, 
          body: JSON.stringify(data) 
        });
        if (res.ok) { closeModal('editModal'); loadUsers(); alert('ì‚¬ìš©ì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else { const err = await res.json(); alert(err.error || 'ìˆ˜ì • ì‹¤íŒ¨'); }
      } catch (e) { alert('ì„œë²„ ì˜¤ë¥˜'); }
    }

    async function deleteUser(userId) {
      if (!confirm('ì •ë§ë¡œ ì´ ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const res = await fetch(API_BASE+'/api/admin/users/'+userId, { 
          method: 'DELETE', 
          headers: { 'Authorization': 'Bearer '+adminToken } 
        });
        if (res.ok) { loadUsers(); loadStats(); alert('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else { const err = await res.json(); alert(err.error || 'ì‚­ì œ ì‹¤íŒ¨'); }
      } catch (e) { alert('ì„œë²„ ì˜¤ë¥˜'); }
    }

    // ============ Announcements ============
    async function loadAnnouncements() {
      try {
        const res = await fetch(API_BASE+'/api/admin/announcements', { headers: { 'Authorization': 'Bearer '+adminToken } });
        const data = await res.json();
        renderAnnouncements(data);
      } catch (e) { console.error(e); }
    }

    function renderAnnouncements(announcements) {
      const container = document.getElementById('announcementsList');
      if (announcements.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl p-8 shadow text-center text-gray-500">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      container.innerHTML = announcements.map(a => `
        <div class="bg-white rounded-xl p-4 shadow">
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="px-2 py-1 rounded text-xs ${getTypeColor(a.type)}">${getTypeLabel(a.type)}</span>
              <span class="ml-2 px-2 py-1 rounded text-xs ${a.isActive?'bg-green-100 text-green-800':'bg-gray-100 text-gray-600'}">${a.isActive?'í™œì„±':'ë¹„í™œì„±'}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="editAnnouncement(${a.id})" class="text-orange-600 hover:text-orange-800 text-sm">ìˆ˜ì •</button>
              <button onclick="deleteAnnouncement(${a.id})" class="text-red-600 hover:text-red-800 text-sm">ì‚­ì œ</button>
            </div>
          </div>
          <h4 class="font-semibold text-lg mb-1">${a.title}</h4>
          <p class="text-gray-600 text-sm whitespace-pre-wrap">${a.content}</p>
          <div class="mt-2 text-xs text-gray-400">
            ìƒì„±: ${formatDate(a.createdAt)} ${a.expiresAt ? 'Â· ë§Œë£Œ: '+formatDate(a.expiresAt) : ''}
          </div>
        </div>
      `).join('');
    }

    function getTypeColor(type) {
      switch(type) {
        case 'update': return 'bg-blue-100 text-blue-800';
        case 'event': return 'bg-purple-100 text-purple-800';
        case 'maintenance': return 'bg-red-100 text-red-800';
        default: return 'bg-orange-100 text-orange-800';
      }
    }

    function getTypeLabel(type) {
      switch(type) {
        case 'update': return 'ì—…ë°ì´íŠ¸';
        case 'event': return 'ì´ë²¤íŠ¸';
        case 'maintenance': return 'ì ê²€';
        default: return 'ê³µì§€';
      }
    }

    function openAnnouncementModal(announcement = null) {
      document.getElementById('announcementModalTitle').textContent = announcement ? 'ê³µì§€ì‚¬í•­ ìˆ˜ì •' : 'ìƒˆ ê³µì§€ì‚¬í•­';
      document.getElementById('announcementId').value = announcement?.id || '';
      document.getElementById('announcementType').value = announcement?.type || 'notice';
      document.getElementById('announcementTitle').value = announcement?.title || '';
      document.getElementById('announcementContent').value = announcement?.content || '';
      document.getElementById('announcementShowPopup').checked = announcement?.showPopup ?? true;
      document.getElementById('announcementIsActive').checked = announcement?.isActive ?? true;
      document.getElementById('announcementExpiresAt').value = announcement?.expiresAt ? new Date(announcement.expiresAt).toISOString().slice(0,16) : '';
      document.getElementById('announcementModal').classList.add('active');
    }

    async function editAnnouncement(id) {
      try {
        const res = await fetch(API_BASE+'/api/admin/announcements', { headers: { 'Authorization': 'Bearer '+adminToken } });
        const announcements = await res.json();
        const announcement = announcements.find(a => a.id === id);
        if (announcement) openAnnouncementModal(announcement);
      } catch (e) { alert('ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
    }

    async function saveAnnouncement(e) {
      e.preventDefault();
      const id = document.getElementById('announcementId').value;
      const data = {
        type: document.getElementById('announcementType').value,
        title: document.getElementById('announcementTitle').value,
        content: document.getElementById('announcementContent').value,
        showPopup: document.getElementById('announcementShowPopup').checked,
        isActive: document.getElementById('announcementIsActive').checked,
        expiresAt: document.getElementById('announcementExpiresAt').value || null
      };
      try {
        const url = id ? API_BASE+'/api/admin/announcements/'+id : API_BASE+'/api/admin/announcements';
        const res = await fetch(url, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Authorization': 'Bearer '+adminToken, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) { closeModal('announcementModal'); loadAnnouncements(); alert(id ? 'ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ê³µì§€ì‚¬í•­ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else { const err = await res.json(); alert(err.error || 'ì €ì¥ ì‹¤íŒ¨'); }
      } catch (e) { alert('ì„œë²„ ì˜¤ë¥˜'); }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('ì •ë§ë¡œ ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const res = await fetch(API_BASE+'/api/admin/announcements/'+id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer '+adminToken }
        });
        if (res.ok) { loadAnnouncements(); alert('ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else { const err = await res.json(); alert(err.error || 'ì‚­ì œ ì‹¤íŒ¨'); }
      } catch (e) { alert('ì„œë²„ ì˜¤ë¥˜'); }
    }

    // ============ Surveys ============
    async function loadSurveys() {
      try {
        const res = await fetch(API_BASE+'/api/admin/surveys', { headers: { 'Authorization': 'Bearer '+adminToken } });
        const data = await res.json();
        
        document.getElementById('surveyTotal').textContent = data.stats.totalResponses || '0';
        document.getElementById('surveyAvgRating').textContent = data.stats.avgRating || '-';
        document.getElementById('surveyRecommendRate').textContent = (data.stats.recommendRate || '0') + '%';
        
        const featureStats = data.stats.featureStats || {};
        const topFeature = Object.entries(featureStats).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('surveyTopFeature').textContent = topFeature ? getFeatureLabel(topFeature[0]) : '-';
        
        renderSurveys(data.responses || []);
      } catch (e) { console.error(e); }
    }

    function getFeatureLabel(feature) {
      const labels = {
        'solo_riding': 'ê°œì¸ ì£¼í–‰',
        'group_riding': 'ê·¸ë£¹ ë¼ì´ë”©',
        'statistics': 'í†µê³„/ë¶„ì„',
        'community': 'ì»¤ë®¤ë‹ˆí‹°',
        'challenges': 'ì±Œë¦°ì§€'
      };
      return labels[feature] || feature;
    }

    function renderSurveys(responses) {
      const tbody = document.getElementById('surveysTableBody');
      if (responses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">ì„¤ë¬¸ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      tbody.innerHTML = responses.map(r => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3 text-sm">${r.userName || r.userEmail || 'ID:'+r.userId}</td>
          <td class="px-4 py-3 text-sm">${'â­'.repeat(r.rating || 0)}</td>
          <td class="px-4 py-3 text-sm">${r.wouldRecommend ? 'âœ… ì˜ˆ' : 'âŒ ì•„ë‹ˆì˜¤'}</td>
          <td class="px-4 py-3 text-sm">${getFeatureLabel(r.mostUsedFeature)}</td>
          <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate" title="${r.feedback || ''}">${r.feedback || '-'}</td>
          <td class="px-4 py-3 text-sm text-gray-600">${formatDate(r.createdAt)}</td>
        </tr>
      `).join('');
    }

    // ============ Bugs ============
    async function loadBugs() {
      try {
        const res = await fetch(API_BASE+'/api/admin/bugs', { headers: { 'Authorization': 'Bearer '+adminToken } });
        const data = await res.json();
        renderBugs(data);
      } catch (e) { console.error(e); }
    }

    function renderBugs(bugs) {
      const container = document.getElementById('bugsList');
      if (bugs.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl p-8 shadow text-center text-gray-500">ë²„ê·¸ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      container.innerHTML = bugs.map(b => `
        <div class="bg-white rounded-xl p-4 shadow">
          <div class="flex justify-between items-start mb-2">
            <div class="flex gap-2 flex-wrap">
              <span class="px-2 py-1 rounded text-xs ${getSeverityColor(b.severity)}">${getSeverityLabel(b.severity)}</span>
              <span class="px-2 py-1 rounded text-xs ${getStatusColor(b.status)}">${getStatusLabel(b.status)}</span>
            </div>
            <select onchange="updateBugStatus(${b.id}, this.value)" class="text-sm border rounded px-2 py-1">
              <option value="pending" ${b.status==='pending'?'selected':''}>ëŒ€ê¸°</option>
              <option value="in_progress" ${b.status==='in_progress'?'selected':''}>ì²˜ë¦¬ ì¤‘</option>
              <option value="resolved" ${b.status==='resolved'?'selected':''}>í•´ê²°ë¨</option>
            </select>
          </div>
          <h4 class="font-semibold mb-1">${b.title}</h4>
          <p class="text-gray-600 text-sm mb-2">${b.description}</p>
          ${b.stepsToReproduce ? '<p class="text-gray-500 text-xs mb-2"><strong>ì¬í˜„ ë°©ë²•:</strong> '+b.stepsToReproduce+'</p>' : ''}
          ${b.deviceInfo ? '<p class="text-gray-400 text-xs mb-2">ê¸°ê¸°: '+b.deviceInfo+'</p>' : ''}
          ${renderScreenshots(b.screenshotUrls)}
          <div class="mt-2 text-xs text-gray-400">
            ì‹ ê³ ì: ${b.userName || b.userEmail || 'ID:'+b.userId} Â· ${formatDate(b.createdAt)}
          </div>
        </div>
      `).join('');
    }

    function renderScreenshots(screenshots) {
      if (!screenshots) return '';
      try {
        const urls = JSON.parse(screenshots);
        if (!urls || urls.length === 0) return '';
        return '<div class="flex gap-2 mt-2">' + urls.map(url => 
          '<img src="'+url+'" class="w-20 h-20 object-cover rounded cursor-pointer" onclick="window.open(\''+url+'\')">'
        ).join('') + '</div>';
      } catch (e) { return ''; }
    }

    function getSeverityColor(severity) {
      switch(severity) {
        case 'critical': return 'bg-red-100 text-red-800';
        case 'high': return 'bg-orange-100 text-orange-800';
        case 'medium': return 'bg-yellow-100 text-yellow-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function getSeverityLabel(severity) {
      switch(severity) {
        case 'critical': return 'ì‹¬ê°';
        case 'high': return 'ë†’ìŒ';
        case 'medium': return 'ë³´í†µ';
        default: return 'ë‚®ìŒ';
      }
    }

    function getStatusColor(status) {
      switch(status) {
        case 'resolved': return 'bg-green-100 text-green-800';
        case 'in_progress': return 'bg-blue-100 text-blue-800';
        default: return 'bg-gray-100 text-gray-800';
      }
    }

    function getStatusLabel(status) {
      switch(status) {
        case 'resolved': return 'í•´ê²°ë¨';
        case 'in_progress': return 'ì²˜ë¦¬ ì¤‘';
        default: return 'ëŒ€ê¸°';
      }
    }

    async function updateBugStatus(id, status) {
      try {
        const res = await fetch(API_BASE+'/api/admin/bugs/'+id+'/status', {
          method: 'PUT',
          headers: { 'Authorization': 'Bearer '+adminToken, 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        if (res.ok) { loadBugs(); }
        else { const err = await res.json(); alert(err.error || 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨'); }
      } catch (e) { alert('ì„œë²„ ì˜¤ë¥˜'); }
    }

    // ============ Posts ============
    async function loadPosts() {
      try {
        const res = await fetch(API_BASE+'/api/admin/posts', { headers: { 'Authorization': 'Bearer '+adminToken } });
        const data = await res.json();
        renderPosts(data);
      } catch (e) { console.error(e); }
    }

    function renderPosts(posts) {
      const container = document.getElementById('postsList');
      if (posts.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl p-8 shadow text-center text-gray-500">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      container.innerHTML = posts.map(p => `
        <div class="bg-white rounded-xl p-4 shadow">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="text-sm text-gray-500 mb-1">${p.authorName || p.authorEmail || 'ID:'+p.authorId} Â· ${formatDate(p.createdAt)}</div>
              <p class="text-gray-800">${p.content}</p>
              ${renderPostImages(p.imageUrls)}
              <div class="flex gap-4 mt-2 text-xs text-gray-500">
                <span>â¤ï¸ ${p.likeCount || 0}</span>
                <span>ğŸ’¬ ${p.commentCount || 0}</span>
                <span>ğŸ‘ ${p.viewCount || 0}</span>
              </div>
            </div>
            <button onclick="deletePost(${p.id})" class="text-red-600 hover:text-red-800 text-sm ml-4">ì‚­ì œ</button>
          </div>
        </div>
      `).join('');
    }

    function renderPostImages(imageUrls) {
      if (!imageUrls) return '';
      try {
        const urls = JSON.parse(imageUrls);
        if (!urls || urls.length === 0) return '';
        return '<div class="flex gap-2 mt-2">' + urls.map(url => 
          '<img src="'+url+'" class="w-16 h-16 object-cover rounded">'
        ).join('') + '</div>';
      } catch (e) { return ''; }
    }

    async function deletePost(id) {
      if (!confirm('ì •ë§ë¡œ ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const res = await fetch(API_BASE+'/api/admin/posts/'+id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer '+adminToken }
        });
        if (res.ok) { loadPosts(); alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        else { const err = await res.json(); alert(err.error || 'ì‚­ì œ ì‹¤íŒ¨'); }
      } catch (e) { alert('ì„œë²„ ì˜¤ë¥˜'); }
    }

    function formatDate(d) { 
      if (!d) return '-'; 
      return new Date(d).toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); 
    }
  </script>
</body>
</html>
